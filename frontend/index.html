<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FRA Atlas Prototype</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>body,html {margin:0; padding:0; height:100%;} #map{height:100%;}</style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([22.0, 80.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    fetch('/api/fra').then(r=>r.json()).then(data=>{
      L.geoJSON(data,{onEachFeature:(f,l)=>l.bindPopup("Patta Holder: "+f.properties.name)}).addTo(map);
    });
    fetch('/api/water').then(r=>r.json()).then(data=>{
      L.geoJSON(data,{style:{color:'blue'}}).addTo(map);
    });
    fetch('/api/veg').then(r=>r.json()).then(data=>{
      L.geoJSON(data,{style:{color:'green'}}).addTo(map);
    });
    let fraLayer; 
    let fraData;

fetch('/api/fra').then(r=>r.json()).then(data=>{
  fraData = data;
  fraLayer = L.geoJSON(data,{
    onEachFeature:(f,l)=>l.bindPopup("Patta Holder: "+f.properties.name)
  }).addTo(map);
  fraCount = data.features.length;
  updateStats();
});

function applyFilters() {
  let stateVal = document.getElementById("stateFilter").value;
  let tribeVal = document.getElementById("tribeFilter").value;

  if (fraLayer) {
    map.removeLayer(fraLayer);
  }

  let filtered = {
    type: "FeatureCollection",
    features: fraData.features.filter(f=>{
      let matchState = !stateVal || f.properties.state === stateVal;
      let matchTribe = !tribeVal || f.properties.tribe === tribeVal;
      return matchState && matchTribe;
    })
  };

  fraCount = filtered.features.length;
  fraLayer = L.geoJSON(filtered,{
    onEachFeature:(f,l)=>l.bindPopup(
      `Patta Holder: ${f.properties.name}<br>State: ${f.properties.state}<br>Tribe: ${f.properties.tribe}`
    )
  }).addTo(map);

  updateStats();
}

  </script>
  <div class="card">
  <h3>Filters</h3>
  <label>State: 
    <select id="stateFilter" onchange="applyFilters()">
      <option value="">All</option>
      <option value="Madhya Pradesh">Madhya Pradesh</option>
      <option value="Odisha">Odisha</option>
      <option value="Tripura">Tripura</option>
      <option value="Telangana">Telangana</option>
    </select>
  </label><br><br>
  <label>Tribal Group: 
    <select id="tribeFilter" onchange="applyFilters()">
      <option value="">All</option>
      <option value="Gond">Gond</option>
      <option value="Santhal">Santhal</option>
      <option value="Khasi">Khasi</option>
    </select>
  </label>
</div>

<div class="card">
  <h3>Stats</h3>
  <p id="stats">Loading...</p>
</div>

</body>
</html>

